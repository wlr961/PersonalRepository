<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script type="text/javascript" src="scripts/boot.js"></script>
</head>
<body>
<div allowResize="false" width="100%">
        <div class="mini-toolbar" style="border-bottom:0;padding:0px;" >
            <table style="width:100%;">
                 <tr>
                    <td style="width:100%;">      
                    </td>
                    <td style="white-space:nowrap;">
                        <input id="key1" class="mini-textbox" emptyText="请输入用户课题名称" style="width:150px;" onenter="onKeyEnter"/> 
                        <input id="key2" class="mini-textbox"  emptyText="请输入用教师名称" alwaysView="true" />  
                        <a class="mini-button" onclick="search()">查询</a>
                    </td>
                </tr>
            </table>           
        </div>
    </div>
    <div id="datagrid1" class="mini-datagrid"  allowResize="false"  width="100%"
        url="/WlrBiBased/ChooseBiBasedAction" idField="id" multiSelect="true" >
        <div property="columns">
            <div type="indexcolumn"></div>
            <!-- <div type="checkcolumn" ></div> -->        
            <div field="bibno" width="120" headerAlign="center" allowSort="true">课题序号</div>    
            <div field="bibtitle" width="120" headerAlign="center" allowSort="true">课题题目</div>  
            <div field="bibcontent" width="120" renderer="onGenderRenderer" >课题要求</div>  
            <div field="adviser" width="120" renderer="onGenderRendere" >指导老师</div>
            <div field="student" width="100" dateFormat="yyyy-MM-dd">选课学生</div>          
            <div field="edit" width="100"  renderer="onActionRenderer" >操作</div>                                                 
        </div>
    </div>
</body>
 <script type="text/javascript">
 var url=location.search;
 var Request=new Object();
 if(url.indexOf("?")!=-1)
 	{
 	var str=url.substr(1);
 	var strs=str.split("&");
 	for(var i=0;i<strs.length;i++)
 		{
 		  Request[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);
 		}
 	} 
    mini.parse();
    var grid = mini.get("datagrid1");
    if(Request["userdegree"]=="学生")
	{
    selectedAlready();
    getCount();
	}
    else if(Request["userdegree"]=="教师")
    	{
    	 grid.load({"flag":"selectTeaBiBased","adviser":Request["username"]});
    	}
    var select=0;
    //判断学生是否已经选中题目
    function selectedAlready()
    {
   	 $.ajax({            	
         url: "/WlrBiBased/ChooseBiBasedAction",
         data:{username:Request["username"],flag:"selectedAlready"},
         cache: false,
         success: function (text) {
        	 var jsonData = JSON.parse(text); 
        	 select=jsonData;
        	 alert("select"+jsonData);
      	   if(select==1)
    	   {
    	   grid.load({"flag":"selectBiBased","student":Request["username"]});
    	   }
           else 
    	   {
    	   grid.load({"flag":"selectBiBased","student":Request["username"],"selected":"not"});
    	   }
        	 
         },
         error: function (jqXHR, textStatus, errorThrown) {
        	 mini.alert("failure","tip",function(){});
         }
     });
    }


   if(Request["userdegree"]=="管理员")
	{
    grid.load({"flag":"selectBiBased"});
	}
 
   // grid.load({"flag":"selectBiBased"});

    function search(){
    	var search1 = mini.get("key1");
    	var search2 = mini.get("key2");
    	var arg1=search1.getValue();
    	var arg2=search2.getValue();
    	grid.load({"bibtitle":arg1,"adviser":arg2,"flag":"selectBiBased"});	
    }
    
    

    //操作渲染器
    function onActionRenderer(e) {
    	var grid = e.sender;
    	var record = e.record;
    	var uid = record._uid;
    	var rowIndex = e.rowIndex;
    	if(Request["userdegree"]=="学生")
    		{
    		if(select==1)
    			{
    			var s='';
    			}
    		else
    			{
    			var s = '<a  class="Edit_Button"  href="javascript:selectTest()">选   择</a> &nbsp&nbsp<a class="Edit_Button" href="javascript:remove()">取消选择</a> &nbsp';
            	
    			}
        	
    		}
    	else
    		{
    		if(certened==1)
    			{
                var row = grid.getSelected();
                
    			var s = '<text>通过</text> &nbsp';
    			}
               else
               {
            	   var s = '<a class="Edit_Button" href="javascript:certen()">确认</a> &nbsp';
               }
    		
    		}
    	return s;
     
    }
    
  function  selectTest()
  {
	  if(index<3)
		  {
		  var rows = grid.getSelecteds();
		  if (rows.length > 0) {
	          if (confirm("确定选择此课题？")) {
	        	  var json=mini.encode(rows);
	              var ids = [];
	              for (var i = 0, l = rows.length ;i < l; i++) {
	                  var r = rows[i];
	                  ids.push(r.bibno);
	              }
	              var id = ids.join(',');
	              grid.loading("操作中，请稍后......");
	              $.ajax({
	                  url: "/WlrBiBased/ChooseBiBasedAction" ,
	                  data:{data:id,selecter:Request["username"],flag:"addStuBiBased"},
	                  success: function (text) {
	                  	 grid.reload(); 
	                //  	selectedAlready();
	                  	 getCount();
	                  },
	                  error: function () {
	                  }
	              });
	          }
	      } 
	      else
	      {
	          alert("请选中一条记录");
	      }
		  }
	  else
		  {
		  alert("你最多预选择3个毕设课题");
		  }

  }
    
    var index=0;
    //获取该学生选择的课题数目
    function getCount()
    {
   	 $.ajax({            	
         url: "/WlrBiBased/ChooseBiBasedAction",
         data:{username:Request["username"],flag:"selectCount"},
         cache: false,
         success: function (text) {
        	 var jsonData = JSON.parse(text); 
        	 index=jsonData;
        	 alert("index"+index);
        	 
         },
         error: function (jqXHR, textStatus, errorThrown) {
        	 mini.alert("failure","tip",function(){});
         }
     });
    }
    
      
    
    function remove() {        
        var rows = grid.getSelecteds();
        if (rows.length > 0) {
            if (confirm("确定取消选择？")) {
                var ids = [];
                for (var i = 0, l = rows.length; i < l; i++) {
                    var r = rows[i];
                    ids.push(r.bibno);
                }
                var id = ids.join(',');
                grid.loading("操作中，请稍后......");
                $.ajax({
                    url: "/WlrBiBased/ChooseBiBasedAction" ,
                    data:{data:id,selecter:Request["username"],flag:"cancelStuBiBased"},
                    success: function (text) {
                    	 grid.reload(); 
                    	 getCount();
                    },
                    error: function () {
                    }
                });
            }
        } else {
            alert("请选中一条记录");
        }
    }
    
    var certened=0;
    function certen() {        
        var rows = grid.getSelecteds();
        if (rows.length > 0) {
            if (confirm("确定选择？")) {
              var ids = [];
                var stus=[];
                for (var i = 0, l = rows.length; i < l; i++) {
                    var r = rows[i];
                    ids.push(r.bibno);
                    stus.push(r.student);
                }
                var id = ids.join(',');
                var stu=stus.join(',');
                //var id =row.bibno;
                //var stu=row.student
                grid.loading("操作中，请稍后......");
                $.ajax({
                    url: "/WlrBiBased/ChooseBiBasedAction" ,
                    data:{data:id,selecter:stu,flag:"certenStuBiBased"},
                    success: function (text) {
                   	 var jsonData = JSON.parse(text); 
                   	certened=jsonData;
                    	 grid.reload(); 
                    },
                    error: function () {
                    }
                });
            }
        } else {
            alert("请选中一条记录");
        }
    }  
 </script>
</html>